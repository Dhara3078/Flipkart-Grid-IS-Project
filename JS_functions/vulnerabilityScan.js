const { json } = require('body-parser');
const nodeCmd = require('node-cmd');
// vulnerability Scanner
//scans the repo for vulnerability.
const vulnerabilityScan = (url) => {
        return new Promise((resolve, reject) => {
                console.log(url);

                nodeCmd.runSync('npm install -g snyk');
                nodeCmd.runSync('snyk auth 3fb8d4f3-00eb-49cc-ba59-21b028e30dc8');
                const synkTest = 'snyk test --json ' + url;

                let averageScore = 0;
                nodeCmd.run(
                        synkTest,
                        function (err, data, stderr) {
                                const obj = JSON.parse(data);

                                //extract vulnerability array
                                let vulnerabilityArray = obj["vulnerabilities"];

                                let n = vulnerabilityArray.length;
                                let totalScore = 0;

                                //calculate total cvss score
                                for (let i = 0; i < n; i++) {
                                        const element = vulnerabilityArray[i];
                                        totalScore += element["cvssScore"];
                                }

                                //take average and return
                                if (n != 0)
                                        averageScore = parseInt(totalScore / n);
                                resolve(averageScore);
                        });

        });
}
module.exports = vulnerabilityScan;